// Code generated by https://github.com/zhufuyi/sponge

package service

import (
	"context"
	"errors"

	creationV1 "creation/api/creation/v1"
	"creation/internal/cache"
	"creation/internal/dao"
	"creation/internal/ecode"
	"creation/internal/model"

	"github.com/zhufuyi/sponge/pkg/grpc/interceptor"
	"github.com/zhufuyi/sponge/pkg/logger"
	"github.com/zhufuyi/sponge/pkg/mysql/query"
	"google.golang.org/grpc"
)

const (
	// 点赞类型
	likeTypePost    = 1 // 帖子点赞
	likeTypeComment = 2 // 评论点赞

	// 点赞状态
	likeStatusUnliked = 0 // 未点赞
	likeStatusLiked   = 1 // 已点赞
)

func init() {
	registerFns = append(registerFns, func(server *grpc.Server) {
		creationV1.RegisterLikeServiceServer(server, NewLikeServiceServer())
	})
}

var _ creationV1.LikeServiceServer = (*likeService)(nil)

type likeService struct {
	creationV1.UnimplementedLikeServiceServer

	userLikeDao dao.UserLikeDao
	postDao     dao.PostDao
	commentDao  dao.CommentDao
}

// NewLikeServiceServer create a server
func NewLikeServiceServer() creationV1.LikeServiceServer {
	return &likeService{
		userLikeDao: dao.NewUserLikeDao(
			model.GetDB(),
			cache.NewUserLikeCache(model.GetCacheType()),
		),
		postDao: dao.NewPostDao(
			model.GetDB(),
			cache.NewPostCache(model.GetCacheType()),
		),
		commentDao: dao.NewCommentDao(
			model.GetDB(),
			cache.NewCommentCache(model.GetCacheType()),
		),
	}
}

// Create 点赞
func (s *likeService) Create(ctx context.Context, req *creationV1.CreateLikeRequest) (*creationV1.CreateLikeReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	// 判断点赞对象是否存在
	err = s.checkLikeExist(ctx, req.ObjType, req.ObjId)
	if err != nil {
		return nil, err
	}

	// 判断是否已经点赞过
	userLike, err := s.userLikeDao.GetByUser(ctx, req.UserId, int(req.ObjType), req.ObjId)
	if err != nil && !errors.Is(err, model.ErrRecordNotFound) {
		logger.Error("s.userLikeDao.GetByUser error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}
	if userLike.Status == likeStatusLiked {
		return &creationV1.CreateLikeReply{}, nil
	}

	db := model.GetDB()
	tx := db.Begin()
	if tx.Error != nil {
		logger.Error("tx error", logger.Err(err), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// 点赞
	if userLike.ID == 0 {
		// 创建新点赞
		userLikeRecord := &model.UserLike{
			ObjType: int(req.ObjType),
			ObjID:   req.ObjId,
			UserID:  req.UserId,
			Status:  likeStatusLiked,
		}
		_, err = s.userLikeDao.CreateByTx(ctx, tx, userLikeRecord)
		if err != nil {
			tx.Rollback()
			logger.Error("s.userLikeDao.CreateByTx error", logger.Err(err), logger.Any("userLike", userLikeRecord), interceptor.ServerCtxRequestIDField(ctx))
			return nil, ecode.StatusInternalServerError.Err()
		}
	} else {
		// 更新点赞状态
		err = s.userLikeDao.UpdateStatusByTx(ctx, tx, userLike.ID, likeStatusLiked)
		if err != nil {
			tx.Rollback()
			logger.Error("s.userLikeDao.UpdateByTx error", logger.Err(err), logger.Any("id", userLike.ID), interceptor.ServerCtxRequestIDField(ctx))
			return nil, ecode.StatusInternalServerError.Err()
		}
	}

	// 点赞数量+1
	switch req.ObjType {
	case likeTypePost:
		err = s.postDao.IncrLikeCountByTx(ctx, tx, req.ObjId)
		if err != nil {
			tx.Rollback()
			logger.Error("s.postDao.IncrLikeCountByTx error", logger.Err(err), interceptor.ServerCtxRequestIDField(ctx))
			return nil, ecode.StatusInternalServerError.Err()
		}
	case likeTypeComment:
		err = s.commentDao.IncrLikeCountByTx(ctx, tx, req.ObjId)
		if err != nil {
			tx.Rollback()
			logger.Error("s.commentDao.IncrLikeCountByTx error", logger.Err(err), interceptor.ServerCtxRequestIDField(ctx))
			return nil, ecode.StatusInternalServerError.Err()
		}
	}

	err = tx.Commit().Error
	if err != nil {
		tx.Rollback()
		logger.Error("tx.Commit error", logger.Err(err), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}

	return &creationV1.CreateLikeReply{}, nil
}

// Delete 取消点赞
func (s *likeService) Delete(ctx context.Context, req *creationV1.DeleteLikeRequest) (*creationV1.DeleteLikeReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	// 判断点赞对象是否存在
	err = s.checkLikeExist(ctx, req.ObjType, req.ObjId)
	if err != nil {
		return nil, err
	}

	// 判断是否已经取消点赞
	userLike, err := s.userLikeDao.GetByUser(ctx, req.UserId, int(req.ObjType), req.ObjId)
	if err != nil {
		if errors.Is(err, model.ErrRecordNotFound) {
			logger.Warn("s.userLikeDao.GetByUser error", logger.Err(err), logger.Uint64("id", req.ObjId), interceptor.ServerCtxRequestIDField(ctx))
			return nil, ecode.StatusNotFound.Err()
		}
		logger.Error("s.userLikeDao.GetByUser error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}
	if userLike.Status == likeStatusUnliked {
		return &creationV1.DeleteLikeReply{}, nil
	}

	db := model.GetDB()
	tx := db.Begin()
	if tx.Error != nil {
		logger.Error("tx error", logger.Err(err), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// 取消点赞
	err = s.userLikeDao.UpdateStatusByTx(ctx, tx, userLike.ID, likeStatusUnliked)
	if err != nil {
		tx.Rollback()
		logger.Error("s.userLikeDao.UpdateByTx error", logger.Err(err), logger.Any("id", userLike.ID), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}

	// 点赞数量-1
	switch req.ObjType {
	case likeTypePost:
		err = s.postDao.DecrLikeCountByTx(ctx, tx, req.ObjId)
		if err != nil {
			tx.Rollback()
			logger.Error("s.postDao.DecrLikeCountByTx error", logger.Err(err), interceptor.ServerCtxRequestIDField(ctx))
			return nil, ecode.StatusInternalServerError.Err()
		}
	case likeTypeComment:
		err = s.commentDao.DecrLikeCountByTx(ctx, tx, req.ObjId)
		if err != nil {
			tx.Rollback()
			logger.Error("s.commentDao.DecrLikeCountByTx error", logger.Err(err), interceptor.ServerCtxRequestIDField(ctx))
			return nil, ecode.StatusInternalServerError.Err()
		}
	}

	err = tx.Commit().Error
	if err != nil {
		tx.Rollback()
		logger.Error("tx.Commit error", logger.Err(err), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}

	return &creationV1.DeleteLikeReply{}, nil
}

// ListPost 获取帖子点赞列表
func (s *likeService) ListPost(ctx context.Context, req *creationV1.ListPostLikeRequest) (*creationV1.ListPostLikeReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	records, total, err := s.userLikeDao.GetByColumns(ctx, &query.Params{
		Page: int(req.Page),
		Size: int(req.Limit),
		Sort: "-id",
		Columns: []query.Column{
			{
				Name:  "obj_id",
				Value: req.PostId,
			},
			{
				Name:  "obj_type",
				Value: likeTypePost,
			},
			{
				Name:  "status",
				Value: likeStatusLiked,
			},
		},
	})
	if err != nil {
		logger.Error("s.userLikeDao.GetByColumns error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}

	userLikeInfos := []*creationV1.LikeInfo{}
	for _, record := range records {
		userLikeInfos = append(userLikeInfos, convertUserLike(record))
	}

	return &creationV1.ListPostLikeReply{Likes: userLikeInfos, Total: total}, nil
}

// ListComment 获取评论点赞列表
func (s *likeService) ListComment(ctx context.Context, req *creationV1.ListCommentLikeRequest) (*creationV1.ListCommentLikeReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	records, total, err := s.userLikeDao.GetByColumns(ctx, &query.Params{
		Page: int(req.Page),
		Size: int(req.Limit),
		Sort: "-id",
		Columns: []query.Column{
			{
				Name:  "obj_id",
				Value: req.CommentId,
			},
			{
				Name:  "obj_type",
				Value: likeTypeComment,
			},
			{
				Name:  "status",
				Value: likeStatusLiked,
			},
		},
	})
	if err != nil {
		logger.Error("s.userLikeDao.GetByColumns error", logger.Err(err), logger.Any("req", req), interceptor.ServerCtxRequestIDField(ctx))
		return nil, ecode.StatusInternalServerError.Err()
	}

	userLikeInfos := []*creationV1.LikeInfo{}
	for _, record := range records {
		userLikeInfos = append(userLikeInfos, convertUserLike(record))
	}

	return &creationV1.ListCommentLikeReply{Likes: userLikeInfos, Total: total}, nil
}

func (s *likeService) checkLikeExist(ctx context.Context, objType int32, objID uint64) error {
	switch objType {
	case likeTypePost:
		_, err := s.postDao.GetByID(ctx, objID)
		if err != nil {
			if errors.Is(err, model.ErrRecordNotFound) {
				logger.Warn("s.postDao.GetByID error", logger.Err(err), logger.Uint64("id", objID), interceptor.ServerCtxRequestIDField(ctx))
				return ecode.StatusNotFound.Err()
			}
			logger.Error("s.postDao.GetByID error", logger.Err(err), logger.Uint64("id", objID), interceptor.ServerCtxRequestIDField(ctx))
			return ecode.StatusInternalServerError.Err()
		}
	case likeTypeComment:
		_, err := s.commentDao.GetByID(ctx, objID)
		if err != nil {
			if errors.Is(err, model.ErrRecordNotFound) {
				logger.Warn("s.commentDao.GetByID error", logger.Err(err), logger.Uint64("id", objID), interceptor.ServerCtxRequestIDField(ctx))
				return ecode.StatusNotFound.Err()
			}
			logger.Error("s.commentDao.GetByID error", logger.Err(err), logger.Uint64("id", objID), interceptor.ServerCtxRequestIDField(ctx))
			return ecode.StatusInternalServerError.Err()
		}
	}

	return nil
}

func convertUserLike(l *model.UserLike) *creationV1.LikeInfo {
	return &creationV1.LikeInfo{
		Id:        l.ID,
		UserId:    l.UserID,
		ObjType:   int32(l.ObjType),
		ObjId:     l.ObjID,
		Status:    int32(l.Status),
		CreatedAt: l.CreatedAt.Unix(),
		UpdatedAt: l.UpdatedAt.Unix(),
	}
}

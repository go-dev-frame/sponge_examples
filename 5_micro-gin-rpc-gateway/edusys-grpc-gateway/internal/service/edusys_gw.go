// Code generated by https://github.com/zhufuyi/sponge

package service

import (
	"context"

	edusys_gwV1 "edusys_gw/api/edusys_gw/v1"
	userV1 "edusys_gw/api/user/v1"
	"edusys_gw/internal/ecode"
	"edusys_gw/internal/rpcclient"

	"github.com/zhufuyi/sponge/pkg/grpc/interceptor"
	"github.com/zhufuyi/sponge/pkg/logger"
)

var _ edusys_gwV1.UserLogicer = (*userClient)(nil)

type userClient struct {
	userCli userV1.UserClient
}

// NewUserClient create a client
func NewUserClient() edusys_gwV1.UserLogicer {
	return &userClient{
		userCli: userV1.NewUserClient(rpcclient.GetUserRPCConn()),
	}
}

// Register 注册
func (c *userClient) Register(ctx context.Context, req *edusys_gwV1.RegisterRequest) (*edusys_gwV1.RegisterReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.CtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	reply, err := c.userCli.Register(ctx, &userV1.RegisterRequest{
		Email:    req.Email,
		Password: req.Password,
	})
	if err != nil {
		return nil, err
	}

	return &edusys_gwV1.RegisterReply{
		Id: reply.Id,
	}, nil
}

// Login 登录
func (c *userClient) Login(ctx context.Context, req *edusys_gwV1.LoginRequest) (*edusys_gwV1.LoginReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.CtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	reply, err := c.userCli.Login(ctx, &userV1.LoginRequest{
		Email:    req.Email,
		Password: req.Password,
	})
	if err != nil {
		return nil, err
	}

	return &edusys_gwV1.LoginReply{
		Id:    reply.Id,
		Token: reply.Token,
	}, nil
}

// Logout 登出
func (c *userClient) Logout(ctx context.Context, req *edusys_gwV1.LogoutRequest) (*edusys_gwV1.LogoutReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.CtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	_, err = c.userCli.Logout(ctx, &userV1.LogoutRequest{
		Id:    req.Id,
		Token: req.Token,
	})
	if err != nil {
		return nil, err
	}

	return &edusys_gwV1.LogoutReply{}, nil
}

// ChangePassword 修改密码
func (c *userClient) ChangePassword(ctx context.Context, req *edusys_gwV1.ChangePasswordRequest) (*edusys_gwV1.ChangeRegisterReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), interceptor.CtxRequestIDField(ctx))
		return nil, ecode.StatusInvalidParams.Err()
	}

	_, err = c.userCli.ChangePassword(ctx, &userV1.ChangePasswordRequest{
		Id:       req.Id,
		Password: req.Password,
	})
	if err != nil {
		return nil, err
	}

	return &edusys_gwV1.ChangeRegisterReply{}, nil
}

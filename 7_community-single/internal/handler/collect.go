// Code generated by https://github.com/zhufuyi/sponge

package handler

import (
	"context"
	"errors"

	communityV1 "community/api/community/v1"
	"community/internal/cache"
	"community/internal/dao"
	"community/internal/ecode"
	"community/internal/model"

	"github.com/zhufuyi/sponge/pkg/gin/middleware"
	"github.com/zhufuyi/sponge/pkg/logger"
	"github.com/zhufuyi/sponge/pkg/mysql/query"
)

var _ communityV1.CollectServiceLogicer = (*collectServiceHandler)(nil)

type collectServiceHandler struct {
	userCollectDao dao.UserCollectDao
	postDao        dao.PostDao
}

// NewCollectServiceHandler create a handler
func NewCollectServiceHandler() communityV1.CollectServiceLogicer {
	return &collectServiceHandler{
		userCollectDao: dao.NewUserCollectDao(
			model.GetDB(),
			cache.NewUserCollectCache(model.GetCacheType()),
		),
		postDao: dao.NewPostDao(
			model.GetDB(),
			cache.NewPostCache(model.GetCacheType()),
		),
	}
}

// Create 收藏
func (h *collectServiceHandler) Create(ctx context.Context, req *communityV1.CreateCollectRequest) (*communityV1.CreateCollectReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InvalidParams.Err()
	}

	// 判断收藏对象是否存在
	post, err := h.postDao.GetByID(ctx, req.PostId)
	if err != nil {
		if errors.Is(err, model.ErrRecordNotFound) {
			logger.Warn("h.postDao.GetByID error", logger.Err(err), logger.Uint64("postId", req.PostId), middleware.CtxRequestIDField(ctx))
			return nil, ecode.NotFound.Err()
		}
		logger.Error("h.postDao.GetByID error", logger.Err(err), logger.Uint64("postId", req.PostId), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	// 判断是否自己的帖子
	if post.UserID == req.UserId {
		logger.Warn(ecode.ErrCreateCollectService.Msg(), logger.Uint64("postId", req.PostId), middleware.CtxRequestIDField(ctx))
		return nil, ecode.ErrCreateCollectService.Err()
	}

	// 判断是否已经收藏过
	userCollect, err := h.userCollectDao.GetByUserPost(ctx, req.UserId, req.PostId)
	if err != nil && !errors.Is(err, model.ErrRecordNotFound) {
		logger.Error("h.userCollectDao.GetByUserPost error", logger.Err(err), logger.Any("req", req), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}
	if userCollect.ID > 0 {
		return &communityV1.CreateCollectReply{}, nil
	}

	db := model.GetDB()
	tx := db.Begin()
	if tx.Error != nil {
		logger.Error("tx error", logger.Err(err), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	// 创建收藏
	userCollectRecord := &model.UserCollect{
		UserID: req.UserId,
		PostID: req.PostId,
	}
	_, err = h.userCollectDao.CreateByTx(ctx, tx, userCollectRecord)
	if err != nil {
		tx.Rollback()
		logger.Error("h.userCollectDao.CreateByTx error", logger.Err(err), logger.Any("userCollect", userCollectRecord), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	// 收藏数+1
	err = h.postDao.IncrCollectCountByTx(ctx, tx, req.PostId)
	if err != nil {
		tx.Rollback()
		logger.Error("h.postDao.IncrCollectCountByTx error", logger.Err(err), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	err = tx.Commit().Error
	if err != nil {
		tx.Rollback()
		logger.Error("tx.Commit error", logger.Err(err), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	return &communityV1.CreateCollectReply{}, nil
}

// Delete 删除收藏
func (h *collectServiceHandler) Delete(ctx context.Context, req *communityV1.DeleteCollectRequest) (*communityV1.DeleteCollectReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InvalidParams.Err()
	}

	// 判断收藏对象是否存在
	_, err = h.userCollectDao.GetByID(ctx, req.Id)
	if err != nil {
		if errors.Is(err, model.ErrRecordNotFound) {
			logger.Warn("h.userCollectDao.GetByID error", logger.Err(err), logger.Uint64("postId", req.Id), middleware.CtxRequestIDField(ctx))
			return nil, ecode.NotFound.Err()
		}
		logger.Error("h.userCollectDao.GetByID error", logger.Err(err), logger.Uint64("postId", req.Id), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	db := model.GetDB()
	tx := db.Begin()
	if tx.Error != nil {
		logger.Error("tx error", logger.Err(err), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}
	defer func() {
		if r := recover(); r != nil {
			tx.Rollback()
		}
	}()

	err = h.userCollectDao.DeleteByID(ctx, req.Id)
	if err != nil {
		tx.Rollback()
		logger.Warn("h.userCollectDao.DeleteByID error", logger.Err(err), logger.Uint64("id", req.Id), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	err = h.postDao.DecrCollectCountByTx(ctx, tx, req.PostId)
	if err != nil {
		tx.Rollback()
		logger.Warn("h.postDao.DecrCollectCountByTx error", logger.Err(err), logger.Uint64("id", req.PostId), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	err = tx.Commit().Error
	if err != nil {
		tx.Rollback()
		logger.Error("tx.Commit error", logger.Err(err), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	return &communityV1.DeleteCollectReply{}, nil
}

// List 获取收藏列表
func (h *collectServiceHandler) List(ctx context.Context, req *communityV1.ListCollectRequest) (*communityV1.ListCollectReply, error) {
	err := req.Validate()
	if err != nil {
		logger.Warn("req.Validate error", logger.Err(err), logger.Any("req", req), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InvalidParams.Err()
	}

	records, total, err := h.userCollectDao.GetByColumns(ctx, &query.Params{
		Page: int(req.Page),
		Size: int(req.Limit),
		Sort: "-id",
		Columns: []query.Column{
			{
				Name:  "user_id",
				Value: req.UserId,
			},
		},
	})
	if err != nil {
		logger.Error("h.userCollectDao.GetByColumns error", logger.Err(err), logger.Any("req", req), middleware.CtxRequestIDField(ctx))
		return nil, ecode.InternalServerError.Err()
	}

	userCollectInfos := []*communityV1.CollectInfo{}
	for _, record := range records {
		userCollectInfos = append(userCollectInfos, convertUserCollect(record))
	}

	return &communityV1.ListCollectReply{Collects: userCollectInfos, Total: total}, nil
}

func convertUserCollect(c *model.UserCollect) *communityV1.CollectInfo {
	return &communityV1.CollectInfo{
		Id:        c.ID,
		UserId:    c.UserID,
		PostId:    c.PostID,
		CreatedAt: c.CreatedAt.Unix(),
		UpdatedAt: c.UpdatedAt.Unix(),
	}
}

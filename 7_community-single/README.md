### community-single

Community-single is a minimalist version of a community backend service that mainly includes user registration, login, follow-up and other functions, as well as the creation of content (text, images, videos), publishing, commenting, liking, and collecting. These functions are common in various community platforms, video platforms, live broadcast platforms and can be used as a reference for learning.

The community-single project was originally designed as a single web service. The entire service was assisted by the code generation tool [sponge](https://github.com/zhufuyi/sponge). During the process of generating web service code with sponge, the business logic and non-business logic code were separated. The non-business logic code here refers to the web service framework code, In addition to the web service framework code, everything else belongs to business logic code.

The web service egg model analysis diagram is shown below:

![web-http-pb-anatomy](https://raw.githubusercontent.com/zhufuyi/sponge_examples/main/assets/en_web-http-pb-anatomy.png)

Therefore developing a complete web service project focuses on **defining data tables**, **defining api interfaces**, and **writing specific business logic code in template code**. These are 3 nodes which are also the core code of business logic (yolk). Other codes (eggshell and egg white) are generated by sponge which can help you write less code. Below is an introduction to the development process from 0 to completion of the project.

The development process relies on the sponge tool and requires sponge to be installed first. Click to view [installation instructions](https://github.com/zhufuyi/sponge/blob/main/assets/install-en.md).

<br>

### Generate project code

After defining the data tables and API interfaces, generate web service project code based on the proto file in sponge's interface. Enter sponge's UI interface, click on the left menu bar 【protobuf】--> 【Web type】-->【Create web project】, fill in relevant parameters to generate web project code as shown below:

![community-single-web](https://raw.githubusercontent.com/zhufuyi/sponge_examples/main/assets/en_community-single-web.png)

Unzip the code and change the folder name (e.g., community-single). A service only needs to generate code once. In this way, a basic framework for building a web service is completed with one click. Next, you can write business logic code within the web service framework.

<br>
<br>

### Writing Business Logic Code

After being stripped by sponge, business logic code only includes two parts: proto files and mysql tables. Writing business logic code is basically carried out around these two parts.

#### Write business logic code related to proto files

Enter the community-single project directory, open the terminal and execute the command:

```bash
make proto
```

This command generates four parts of code: interface template code, registration route code, API interface error code and swagger document.

<br>

(1) **Generated interface template code**, located in `internal/handler` directory, in these files, method functions correspond one-to-one with rpc method names defined in proto files. By default, each method function has a simple usage example. You only need to write specific logic codes in each method function. The above codes are codes that have been written with specific logic.

(2) **Generated registration route code**, located in `internal/routers` directory, in these files, middleware for setting up api interfaces such as jwt authentication can be set up. The middleware code template for each interface already exists and only needs to uncomment the code to make it effective. Middleware can be set up for both route groups and individual routes.

(3) **Generated interface error codes**, located in `internal/ecode` directory, in these files, default error code variables correspond one-to-one with rpc method names defined in proto files. Add or change business-related error codes here. Note that error codes cannot be repeated otherwise it will trigger panic.

(4) **Generated swagger document**, located in `docs` directory with name apis.swagger.json.

<br>

If you add or change an API interface in the proto file, you need to execute the `make proto` command again to update the code. You will find that code files with a date-time suffix appear in the `internal/handler`, `internal/routers`, and `internal/ecode` directories. Open the file and copy the added or modified part of the code into the code of the same name. After copying the new code, execute the `make clean` command to clear these date-suffix files.

The code generated by the `make proto` command is used to connect web framework code and business logic core code, that is, the protein part. The advantage of this layered code generation is to reduce coding.

<br>

#### Writing business logic code related to MySQL tables

The previously generated web service framework code and part of the business logic code generated according to the proto file do not include operations on MySQL tables. Therefore, it is necessary to generate dao (data access object) code according to MySQL tables. Dao code includes **CRUD** code for tables, cache code, and model code.

Enter the sponge UI interface, click on 【Public】--> 【Generate dao CRUD code】 in the left menu bar, fill in relevant parameters to generate dao code, as shown below:

![community-single-dao](https://raw.githubusercontent.com/zhufuyi/sponge_examples/main/assets/en_community-single-dao.png)

Unzip the dao code and move the internal directory to the community-single directory. This completes adding **CRUD** operation interfaces for MySQL tables. When new MySQL tables are added, you need to specify MySQL tables to generate dao code again.

There are three parts to specifying dao codes generated by MySQL tables.

(1) **Generate model code**, in the `internal/model` directory, this is generated go structure code corresponding to gorm.

(2) **Generate cache code**, in files under the `internal/cache` directory, during the process of writing business logic codes, caches may be used to improve performance. Sometimes default caches (CRUD) for tables cannot meet requirements and additional cache codes need to be added. Sponge supports one-click generation of cache codes. Click on 【Public】--> 【Generate cache codes】 in the left menu bar, fill in parameters to generate codes, then move the unzipped internal directory to community-single directory and directly call cache interfaces in business logic.

(3) **Generate dao codes**, in files under `internal/dao` directory, during writing business logic codes, it will involve operating on MySQL tables. Sometimes default operations (CRUD) cannot meet requirements. At this time, custom functions and implementation codes for operating on MySQL tables need to be manually written. For example comment.go and post.go contain a small number of manually defined function methods for operating on msyql tables.

<br>

During development process sometimes MySQL tables will be modified or added. Codes generated based on MySQL tables need to be synchronized into project codes and handled in two situations:

- After modifying MySQL table update codes: Just generate new model codes based on modified table and replace old model codes. Click on 【Public】--> 【Generate model codes】 in left menu bar, fill in parameters, select changed mysql table then move unzipped internal directory to community-single directory and confirm replacement.
- After adding new mysql table: Just generate new dao codes based on added table and add them into project directory. Click on 【Public】--> 【Generate dao codes】 in left menu bar, fill in parameters, select added mysql table then move unzipped internal directory into community-single directory.

<br>
<br>

### Testing API interface

After writing the business logic code, start the service to test the API interface. Before starting the service for the first time, open the configuration file (`configs/community.yml`) to set the MySQL and Redis addresses, and then execute the command to compile and start the service:

```bash
# Compile and run service
make run
```

Visit `http://localhost:8080/apis/swagger/index.htm` in your browser to enter the swagger interface, as shown below:

![community-single-swagger](https://raw.githubusercontent.com/zhufuyi/sponge_examples/main/assets/community-single-swagger.png)

From the picture, you can see that some API interfaces have a lock mark on the right side, indicating that the request header will carry authorization information Authorization. Whether the server receives a request for authentication is determined by the server. If the server needs to authenticate, it can be set in each `internal/routers/xxx_handler.pb.go` file, that is, canceling the commented code for authentication and enabling the authentication middleware for the API interface.

<br>
